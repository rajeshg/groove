// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "sqlite"
}

model Account {
  id                  String            @id
  email               String            @unique
  firstName           String?
  lastName            String?
  boards              Board[]
  boardMemberships    BoardMember[]
  receivedInvitations BoardInvitation[]
  assignees           Assignee[]
  comments            Comment[]         @relation("CommentCreatedBy")
  createdItems        Item[]            @relation("ItemCreatedBy")
  activities          Activity[]
  Password            Password?
}

model Password {
  id        String  @id
  salt      String
  hash      String
  Account   Account @relation(fields: [accountId], references: [id])
  accountId String  @unique
}

model Board {
  id          String            @id
  name        String
  color       String            @default("#e0e0e0")
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @default(now()) @updatedAt
  columns     Column[]
  items       Item[]
  members     BoardMember[]
  invitations BoardInvitation[]
  assignees   Assignee[]
  activities  Activity[]
  Account     Account           @relation(fields: [accountId], references: [id])
  accountId   String
}

model Column {
  id         String   @id
  name       String
  color      String   @default("#94a3b8")
  order      Float    @default(0)
  isDefault  Boolean  @default(false)
  isExpanded Boolean  @default(true)
  shortcut   String?  @default("c")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
  items      Item[]
  Board      Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId    String
}

model Item {
  id            String    @id
  title         String
  content       String?
  order         Float
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  lastActiveAt  DateTime  @default(now())
  createdBy     String?
  createdByUser Account?  @relation("ItemCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  Column        Column    @relation(fields: [columnId], references: [id], onDelete: Cascade)
  columnId      String
  Board         Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId       String
  Assignee      Assignee? @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  assigneeId    String?
  comments      Comment[]
  activities    Activity[]
}

model Activity {
  id        String   @id
  type      String // 'card_created', 'card_moved', 'card_updated', 'comment_added', 'board_updated', 'column_created', etc.
  content   String? // Additional info like "from To Do to Done" or comment snippet
  createdAt DateTime @default(now())

  // Relations
  board   Board   @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId String

  item   Item?  @relation(fields: [itemId], references: [id], onDelete: SetNull)
  itemId String?

  user   Account? @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId String?
}

model Comment {
  id            String   @id
  content       String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now()) @updatedAt
  createdBy     String?
  createdByUser Account? @relation("CommentCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  Item          Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId        String
}

model Assignee {
  id        String   @id
  name      String
  createdAt DateTime @default(now())
  Board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId   String
  Account   Account? @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId    String?
  items     Item[]

  @@unique([name, boardId])
}

model BoardMember {
  id        String   @id
  role      String   @default("editor")
  createdAt DateTime @default(now())
  Account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId String
  Board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId   String

  @@unique([accountId, boardId])
}

model BoardInvitation {
  id        String   @id
  email     String
  role      String   @default("editor")
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  Board     Board    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId   String
  Account   Account  @relation(fields: [invitedBy], references: [id])
  invitedBy String

  @@unique([email, boardId])
}
